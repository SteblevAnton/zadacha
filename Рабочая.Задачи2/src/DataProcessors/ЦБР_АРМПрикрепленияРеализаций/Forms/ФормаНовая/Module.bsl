

#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	Если Параметры.Свойство("КлиентОтбора") Тогда
		КлиентОтбор = Параметры.КлиентОтбора;
	КонецЕсли;
	
	Элементы.ДеревоЗадачУстановитьЗаСчетКомпании.Видимость = РольДоступна("ЦБР_ЧасыЗаСчетКомпании");
	
	Если Не РольДоступна("ЦБР_РуководительКО") И Не РольДоступна("ПолныеПрава") Тогда
		Менеджер = ПараметрыСеанса.ТекущийПользователь;
		ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(Элементы, "Менеджер", "Доступность", Ложь);
	КонецЕсли;	
	
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	
	ПериодРегистрации = НачалоМесяца(ТекущаяДата());
	ПериодРегистрацииПредставление = ОбщегоНазначенияУТКлиент.ПолучитьПредставлениеПериодаРегистрации(ПериодРегистрации);
	ОбновитьДеревоЗадач();
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовФормы 

&НаКлиенте
Процедура ДеревоЗадачПриАктивизацииСтроки(Элемент)
	ТекДанные = Элементы.ДеревоЗадач.ТекущиеДанные;
	ЧасовВыбрано = 0;
	Если ТекДанные = Неопределено Тогда
		ДеревоЗадачПриАктивизацииСтрокиНаСервере(Неопределено);
		Возврат;
	КонецЕсли;
	
	Если ТекДанные.Задание = ПредопределенноеЗначение("Документ.ЦБР_Задание.ПустаяСсылка") Тогда //выбрана ЗАДАЧА
		ДеревоЗадачПриАктивизацииСтрокиНаСервере(ТекДанные.Родитель, Истина);	
	Иначе
		ДеревоЗадачПриАктивизацииСтрокиНаСервере(ТекДанные.Задание);
	КонецЕсли;
	
		
КонецПроцедуры
                                  
&НаКлиенте
Процедура ПериодРегистрацииПредставлениеНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка) 
	Оповещение = Новый ОписаниеОповещения("ПериодРегистрацииПредставлениеНачалоВыбораЗавершение", ЭтаФорма);
	ОбщегоНазначенияУТКлиент.НачалоВыбораПредставленияПериодаРегистрации(Элемент, СтандартнаяОбработка, ПериодРегистрации, ЭтаФорма, Оповещение); 

	ОбновитьДеревоЗадач();
КонецПроцедуры

&НаКлиенте
Процедура ПериодРегистрацииПредставлениеНачалоВыбораЗавершение(ВыбранноеЗначение, ДопПараметры) Экспорт
	ПериодРегистрации = ВыбранноеЗначение; 
	ПериодРегистрацииПредставление = ОбщегоНазначенияУТКлиент.ПолучитьПредставлениеПериодаРегистрации(ПериодРегистрации);	
КонецПроцедуры

&НаКлиенте
Процедура ПериодРегистрацииПредставлениеРегулирование(Элемент, Направление, СтандартнаяОбработка)
	ОбщегоНазначенияУТКлиент.РегулированиеПредставленияПериодаРегистрации(Направление, СтандартнаяОбработка, ПериодРегистрации, ПериодРегистрацииПредставление);

	ОбновитьДеревоЗадач();	
КонецПроцедуры

&НаКлиенте
Процедура ВыборЭлементовОбщий(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	ВыборЭлементов(Элемент);
КонецПроцедуры

&НаКлиенте
Процедура ВыборЭлементов(Элемент)
	ТекСтрока = Элемент.ТекущиеДанные;
	Если Не ТекСтрока = Неопределено Тогда
		Если Элемент.ТекущийЭлемент.Имя = "ДеревоЗадачЗадание" Тогда		
			Отправка = Новый Структура;
			Отправка.Вставить("Ключ", ТекСтрока.Задание);
			ОткрытьФорму("Документ.ЦБР_Задание.Форма.ФормаДокумента", Отправка); 
		ИначеЕсли Элемент.ТекущийЭлемент.Имя = "ДеревоЗадачРодитель" Тогда		
			Отправка = Новый Структура;
			Отправка.Вставить("Ключ", ТекСтрока.Родитель);
			ОткрытьФорму("Справочник.ЦБР_Задача.Форма.ФормаЭлемента", Отправка); 
		ИначеЕсли Элемент.ТекущийЭлемент.Имя = "ТаблицаРеализацийРеализация" Тогда		
			Отправка = Новый Структура;
			Отправка.Вставить("Ключ", ТекСтрока.Реализация);
			ОткрытьФорму("Документ.РеализацияТоваровУслуг.Форма.ФормаДокумента", Отправка);
		КонецЕсли;		
	КонецЕсли; 	
КонецПроцедуры

&НаКлиенте
Процедура ТаблицаРеализацийВыбранаПриИзменении(Элемент)
	ТекДанныеЗадач = Элементы.ДеревоЗадач.ТекущиеДанные;
	ТекДанные = Элементы.ТаблицаРеализаций.ТекущиеДанные;
	ЧасовВыбрано = ?(ТекДанные.Выбрана, ЧасовВыбрано + ТекДанные.ЧасыОстаток, ЧасовВыбрано - ТекДанные.ЧасыОстаток);
КонецПроцедуры

#КонецОбласти

#Область ЗаполнениеДерева

&НаСервере
Процедура ЗаполнитьДеревоНаСервере()
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ЦБР_СогласованоЗакрытоЧасовОбороты.Регистратор КАК Задание,
	|	ЦБР_СогласованоЗакрытоЧасовОбороты.Исполнитель КАК Исполнитель,
	|	ЦБР_СогласованоЗакрытоЧасовОбороты.Задача КАК Родитель,
	|	ЦБР_СогласованоЗакрытоЧасовОбороты.ВидЧаса КАК ВидЧаса,  
	|	НАЧАЛОПЕРИОДА(ЦБР_СогласованоЗакрытоЧасовОбороты.Период, МЕСЯЦ) КАК ПериодЗП,  
	|   СУММА(ЦБР_СогласованоЗакрытоЧасовОбороты.СогласованоОборот - ЦБР_СогласованоЗакрытоЧасовОбороты.ЗакрытоОборот) КАК Эффективные,
	//|	СУММА(ВЫБОР
	//|			КОГДА ЦБР_СогласованоЗакрытоЧасовОбороты.ВидЧаса = ЗНАЧЕНИЕ(Перечисление.ЦБР_ВидыЧасовПоЗадачам.Платные)
	//|				ТОГДА ЦБР_СогласованоЗакрытоЧасовОбороты.СогласованоОборот - ЦБР_СогласованоЗакрытоЧасовОбороты.ЗакрытоОборот
	//|			ИНАЧЕ 0
	//|		КОНЕЦ) КАК Эффективные,
	|	СУММА(ВЫБОР
	|			КОГДА ЦБР_СогласованоЗакрытоЧасовОбороты.ВидЧаса = ЗНАЧЕНИЕ(Перечисление.ЦБР_ВидыЧасовПоЗадачам.Бесплатные)
	|				ТОГДА ЦБР_СогласованоЗакрытоЧасовОбороты.СогласованоОборот - ЦБР_СогласованоЗакрытоЧасовОбороты.ЗакрытоОборот
	|			ИНАЧЕ 0
	|		КОНЕЦ) КАК Бесплатные,
	|	СУММА(ВЫБОР
	|		КОГДА ЦБР_СогласованоЗакрытоЧасовОбороты.ВидЧаса = ЗНАЧЕНИЕ(Перечисление.ЦБР_ВидыЧасовПоЗадачам.ИТС)
	|			ТОГДА ЦБР_СогласованоЗакрытоЧасовОбороты.СогласованоОборот - ЦБР_СогласованоЗакрытоЧасовОбороты.ЗакрытоОборот
	|		ИНАЧЕ 0
	|	КОНЕЦ) КАК ИТС,
	|	СУММА(ВЫБОР
	|		КОГДА ЦБР_СогласованоЗакрытоЧасовОбороты.ВидЧаса = ЗНАЧЕНИЕ(Перечисление.ЦБР_ВидыЧасовПоЗадачам.Установка)
	|			ТОГДА ЦБР_СогласованоЗакрытоЧасовОбороты.СогласованоОборот - ЦБР_СогласованоЗакрытоЧасовОбороты.ЗакрытоОборот
	|		ИНАЧЕ 0
	|	КОНЕЦ) КАК Установочные,
	|	ЦБР_СогласованоЗакрытоЧасовОбороты.Задача.Заказчик КАК Заказчик
	|ИЗ
	|	РегистрНакопления.ЦБР_СогласованоЗакрытоЧасов.Обороты(, &КонецПериода, Регистратор, ВидЧаса <> &ВидЧасаДемо) КАК ЦБР_СогласованоЗакрытоЧасовОбороты
	|ГДЕ
	|	ЦБР_СогласованоЗакрытоЧасовОбороты.СогласованоОборот > ЦБР_СогласованоЗакрытоЧасовОбороты.ЗакрытоОборот
	|	И ЦБР_СогласованоЗакрытоЧасовОбороты.Задача.Заказчик = &Заказчик 
	|	И ЦБР_СогласованоЗакрытоЧасовОбороты.Задача.Постановщик = &Менеджер
	|	И ЦБР_СогласованоЗакрытоЧасовОбороты.ВидЧаса = &ВидЧаса
	|
	|СГРУППИРОВАТЬ ПО
	|	ЦБР_СогласованоЗакрытоЧасовОбороты.Регистратор,
	|	ЦБР_СогласованоЗакрытоЧасовОбороты.Исполнитель,
	|	ЦБР_СогласованоЗакрытоЧасовОбороты.Задача,
	|	ЦБР_СогласованоЗакрытоЧасовОбороты.ВидЧаса,
    |   НАЧАЛОПЕРИОДА(ЦБР_СогласованоЗакрытоЧасовОбороты.Период, МЕСЯЦ),
    //|	ВЫБОР
	//|		КОГДА ЦБР_СогласованоЗакрытоЧасовОбороты.ВидЧаса = ЗНАЧЕНИЕ(Перечисление.ЦБР_ВидыЧасовПоЗадачам.ИТС)
	//|			ТОГДА ЦБР_СогласованоЗакрытоЧасовОбороты.СогласованоОборот - ЦБР_СогласованоЗакрытоЧасовОбороты.ЗакрытоОборот
	//|		ИНАЧЕ 0
	//|	КОНЕЦ,
	//|	ВЫБОР
	//|		КОГДА ЦБР_СогласованоЗакрытоЧасовОбороты.ВидЧаса = ЗНАЧЕНИЕ(Перечисление.ЦБР_ВидыЧасовПоЗадачам.Установка)
	//|			ТОГДА ЦБР_СогласованоЗакрытоЧасовОбороты.СогласованоОборот - ЦБР_СогласованоЗакрытоЧасовОбороты.ЗакрытоОборот
	//|		ИНАЧЕ 0
	//|	КОНЕЦ,
	|	ЦБР_СогласованоЗакрытоЧасовОбороты.Задача.Заказчик
	|ИТОГИ ПО
	|	Родитель";
	
	Запрос.УстановитьПараметр("ВидЧасаДемо", Перечисления.ЦБР_ВидыЧасовПоЗадачам.Демо);
	Запрос.УстановитьПараметр("КонецПериода", Новый Граница(КонецМесяца(ПериодРегистрации),ВидГраницы.Включая));
	
	Если НЕ ЗначениеЗаполнено(КлиентОтбор) Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "И ЦБР_СогласованоЗакрытоЧасовОбороты.Задача.Заказчик = &Заказчик" , "");
	Иначе
		Запрос.УстановитьПараметр("Заказчик", КлиентОтбор);
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(Менеджер) Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "И ЦБР_СогласованоЗакрытоЧасовОбороты.Задача.Постановщик = &Менеджер" , "");
	Иначе
		Запрос.УстановитьПараметр("Менеджер", Менеджер);
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(ВидЧаса) Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "И ЦБР_СогласованоЗакрытоЧасовОбороты.ВидЧаса = &ВидЧаса" , "");
	Иначе
		Запрос.УстановитьПараметр("ВидЧаса", ВидЧаса);
	КонецЕсли;
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ДеревоРодитель = РезультатЗапроса.Выгрузить(ОбходРезультатаЗапроса.ПоГруппировкам); 
	
	ЗначениеВРеквизитФормы(ДеревоРодитель, "ДеревоЗадач");	
	
	ДеревоЗадач.ПолучитьЭлементы();	 
	
КонецПроцедуры

&НаСервере
Процедура ДеревоЗадачПриАктивизацииСтрокиНаСервере(ПараметрЗадачи, ЭтоРодитель = Ложь)
	
	Если ПараметрЗадачи = Неопределено Тогда
		ОбновитьТаблицуРеализаций();
		Возврат;
	КонецЕсли;
	
	Если ЭтоРодитель Тогда
		ЗаказчикПараметр = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ПараметрЗадачи, "Заказчик");	
	Иначе		
		ЗадачаПараметр = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ПараметрЗадачи, "СсылкаНаЗадачу");
		ЗаказчикПараметр = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ЗадачаПараметр, "Заказчик");
	КонецЕсли; 
	
	ОбновитьТаблицуРеализаций(ЗаказчикПараметр);
	
КонецПроцедуры

&НаКлиенте
Процедура ОбновитьДеревоЗадач(Команда = Неопределено)
	ЗаполнитьДеревоНаСервере();
	РаскрытьДеревоЗадач();
КонецПроцедуры

&НаКлиенте
Процедура РаскрытьДеревоЗадач() 
	
	КоллекцияЭлементовДерева = ДеревоЗадач.ПолучитьЭлементы();
	
	Для Каждого Строка Из КоллекцияЭлементовДерева Цикл
		ИдентификаторСтроки = Строка.ПолучитьИдентификатор();
		Элементы.ДеревоЗадач.Развернуть(ИдентификаторСтроки, Истина);
	КонецЦикла;
	
КонецПроцедуры

#КонецОбласти

#Область РаспределениеЧасов

&НаКлиенте
Процедура ПрикрепитьВыделенныеРеализацииКЗаданию(Команда)  //_Note: добавить контроль выделенных часов у задач и заданий!!
	
	Если ЧасовВыбрано = 0 Тогда
		ОбщегоНазначенияКлиент.СообщитьПользователю("Не выбраны реализации для прикрепления!");
		Возврат;
	КонецЕсли;
	
	//++ проверка выделенных задач на одного контрагента
	//ОдинКонтрагент = Истина; 
	//СтароеЗаданиеЗаказчик = Неопределено;
	//Для Каждого Элемент Из Элементы.ДеревоЗадач.ВыделенныеСтроки Цикл
	//	
	//	ТекущаяСтрока = Элементы.ДеревоЗадач.ДанныеСтроки(Элемент);
	//	
	//	Если СтароеЗаданиеЗаказчик = Неопределено Тогда
	//		СтароеЗаданиеЗаказчик = ТекущаяСтрока.Заказчик;
	//		Продолжить;
	//	КонецЕсли;
	//	
	//	Если СтароеЗаданиеЗаказчик <> ТекущаяСтрока.Заказчик Тогда
	//		ОдинКонтрагент = Ложь;
	//		Прервать;
	//	КонецЕсли;
	//	
	//КонецЦикла; 
	//
	//Если НЕ ОдинКонтрагент Тогда
	//	ОбщегоНазначенияКлиент.СообщитьПользователю("Задачи и задания должны быть от одного заказчика!");
	//	Возврат;
	//КонецЕсли;
    //-- проверка выделенных задач
   
   
	//++распределение задач
	////для нескольких строк	
	//Для Каждого Элемент Из Элементы.ДеревоЗадач.ВыделенныеСтроки Цикл  
	//	
	//	ТекущаяСтрока = Элементы.ДеревоЗадач.ДанныеСтроки(Элемент);
	//	
	//	//++ распределение с проверкой на одновременно выделенного родителя и подчиненного элемента
	//	Если ТекущаяСтрока.Задание = ПредопределенноеЗначение("Документ.ЦБР_Задание.ПустаяСсылка") Тогда //выбран родитель
	//		РодительДляПроверки = ТекущаяСтрока.Родитель;
	//		ПодчиненныеСтрокиРодителя = ТекущаяСтрока.ПолучитьЭлементы();
	//		Для Каждого ПодчиненнаяСтрока Из ПодчиненныеСтрокиРодителя Цикл 
	//			ПрикрепитьВыделенныеРеализацииКЗаданиюНаСервере(ПодчиненнаяСтрока.Задание);
	//		КонецЦикла;
	//	
	//	ИначеЕсли ТекущаяСтрока.Родитель = РодительДляПроверки Тогда // выбрано подчиненное задание уже выбранного родителя
	//		Продолжить;
	//	Иначе // выбрано подчиненное задание (стандартная ситуация)
	//		ПрикрепитьВыделенныеРеализацииКЗаданиюНаСервере(ТекущаяСтрока.Задание); 
	//	КонецЕсли;
	//	//-- распределение с проверкой
	//КонецЦикла;
	//       
	
	
	//Для одной строки 
	ТекущаяСтрока = Элементы.ДеревоЗадач.ТекущиеДанные;
	
	Если ТекущаяСтрока.Задание = ПредопределенноеЗначение("Документ.ЦБР_Задание.ПустаяСсылка") Тогда //выбран родитель
		РодительДляПроверки = ТекущаяСтрока.Родитель;
		ПодчиненныеСтрокиРодителя = ТекущаяСтрока.ПолучитьЭлементы();
		Для Каждого ПодчиненнаяСтрока Из ПодчиненныеСтрокиРодителя Цикл 
			СтруктураПараметры = Новый Структура("ТекущееЗадание,ВидЧаса,ОсталосьРаспределить,ПериодЗП", ПодчиненнаяСтрока.Задание, ПодчиненнаяСтрока.ВидЧаса, ПодчиненнаяСтрока.Эффективные, ПодчиненнаяСтрока.ПериодЗП);
			ЦБР_ПрикрепитьВыделенныеРеализацииКЗаданиюНаСервере(СтруктураПараметры);
		КонецЦикла;
	Иначе //выбрано задание 
		СтруктураПараметры = Новый Структура("ТекущееЗадание,ВидЧаса,ОсталосьРаспределить,ПериодЗП", ТекущаяСтрока.Задание, ТекущаяСтрока.ВидЧаса, ТекущаяСтрока.Эффективные, ТекущаяСтрока.ПериодЗП);
		ЦБР_ПрикрепитьВыделенныеРеализацииКЗаданиюНаСервере(СтруктураПараметры); 
	КонецЕсли;  
	
	//ТаблицаРеализаций.Очистить();
	ОбновитьДеревоЗадач();
	ОбновитьТаблицуРеализаций();
	
КонецПроцедуры 

&НаСервере
Процедура ПрикрепитьВыделенныеРеализацииКЗаданиюНаСервере(ТекущееЗадание) 
	
	Строки        = ТаблицаРеализаций.НайтиСтроки(Новый Структура("Выбрана",Истина));
	ОбъектЗадания = ТекущееЗадание.ПолучитьОбъект();	
	
	Индекс               = 0; 
	ОсталосьРаспределить = 0;
	МожноРаспределить    = 0;   
	
	Для Каждого Строка Из Строки Цикл 
		Если Строка.ЧасыОстаток = 0 Тогда
			Продолжить;
		КонецЕсли;
		Если Индекс = ОбъектЗадания.ЭффективныеЧасы.Количество() Тогда
			Прервать;
		КонецЕсли;
		РаспределитьЧасы(ОбъектЗадания.ЭффективныеЧасы, Строка, Индекс, ОсталосьРаспределить, МожноРаспределить);	
		Строка.ЧасыОстаток = МожноРаспределить;
	КонецЦикла;   
	
	ОбъектЗадания.Записать(РежимЗаписиДокумента.Проведение);
	
КонецПроцедуры

&НаСервере
Процедура ЦБР_ПрикрепитьВыделенныеРеализацииКЗаданиюНаСервере(СтруктураПараметры) 
	
	Строки        = ТаблицаРеализаций.НайтиСтроки(Новый Структура("Выбрана",Истина));
	ОбъектЗадания = СтруктураПараметры.ТекущееЗадание.ПолучитьОбъект();	
	
	Индекс               = 0; 
	МожноРаспределить    = 0;   
	
	Для Каждого Строка Из Строки Цикл 
		
		Если Строка.ЧасыОстаток = 0 Тогда
			Продолжить;
		КонецЕсли;  
		
		Если Строка.ВидЧаса <> СтруктураПараметры.ВидЧаса Тогда
			Продолжить;
		КонецЕсли;  
		
		Если Индекс = ОбъектЗадания.ЧасыЗП.Количество() Тогда
			Прервать;
		КонецЕсли;
		
		ЦБР_РаспределитьЧасы(ОбъектЗадания.ЧасыЗП, Строка, Индекс, СтруктураПараметры, МожноРаспределить);	
		
		Строка.ЧасыОстаток = МожноРаспределить;
	КонецЦикла;   
	
	ОбъектЗадания.Записать(РежимЗаписиДокумента.Проведение);
	
КонецПроцедуры 

&НаСервереБезКонтекста
Процедура ЦБР_РаспределитьЧасы(ЭффективныеЧасы, СтрокаРеализация, Индекс, СтруктураПараметры, МожноРаспределить);
	
	Если СтруктураПараметры.ОсталосьРаспределить = 0 Тогда
		Возврат;
	КонецЕсли;	
	
	СтрокаРаспределения = ЭффективныеЧасы[Индекс];  
	
	Если СтрокаРаспределения.ВидЧаса <> СтрокаРеализация.ВидЧаса Тогда
		Возврат;
	КонецЕсли;	
	
	Если СтрокаРаспределения.ПериодЗП <> СтруктураПараметры.ПериодЗП Тогда
		Индекс = Индекс+1;
		ЦБР_РаспределитьЧасы(ЭффективныеЧасы, СтрокаРеализация, Индекс, СтруктураПараметры, МожноРаспределить);
		Возврат;
	КонецЕсли;	
	
	Если ЗначениеЗаполнено(СтрокаРаспределения.Реализация) Или СтрокаРаспределения.ЗаСчетКомпании Или СтрокаРаспределения.Зачтено Тогда
		Индекс = Индекс+1;
		ЦБР_РаспределитьЧасы(ЭффективныеЧасы, СтрокаРеализация, Индекс, СтруктураПараметры, МожноРаспределить);
		Возврат;
	КонецЕсли;
	
	ЭффективныеЧасыДо = СтрокаРаспределения.ЭффективныеЧасы;
	СтрокаРаспределения.ЭффективныеЧасы = ?(?(МожноРаспределить>0, МожноРаспределить, СтрокаРеализация.ЧасыОстаток) >= СтруктураПараметры.ОсталосьРаспределить, СтруктураПараметры.ОсталосьРаспределить, ?(МожноРаспределить>0, МожноРаспределить, СтрокаРеализация.ЧасыОстаток));
	СтруктураПараметры.ОсталосьРаспределить = СтруктураПараметры.ОсталосьРаспределить - СтрокаРаспределения.ЭффективныеЧасы;
	ОсталисьЭффективныеЧасы = ЭффективныеЧасыДо - СтрокаРаспределения.ЭффективныеЧасы; 
	МожноРаспределить = ?(МожноРаспределить>0,МожноРаспределить,СтрокаРеализация.ЧасыОстаток) - СтрокаРаспределения.ЭффективныеЧасы;

	СтрокаРаспределения.Реализация = СтрокаРеализация.Реализация;

	Индекс = Индекс+1;  
		
	Если СтруктураПараметры.ОсталосьРаспределить > 0 И МожноРаспределить > 0 Тогда
		НоваяСтрока = ЭффективныеЧасы.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрока, ЭффективныеЧасы[Индекс-1]);
		НоваяСтрока.ЭффективныеЧасы = СтруктураПараметры.ОсталосьРаспределить;
		ЭффективныеЧасы.Сдвинуть(НоваяСтрока, -1);
		Возврат;
    ИначеЕсли ОсталисьЭффективныеЧасы > 0 И МожноРаспределить > 0 Тогда
		НоваяСтрока = ЭффективныеЧасы.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрока, ЭффективныеЧасы[Индекс-1]); 
	    НоваяСтрока.Реализация = Неопределено;
		НоваяСтрока.ЭффективныеЧасы = ОсталисьЭффективныеЧасы;
		ЭффективныеЧасы.Сдвинуть(НоваяСтрока, -1);
		Возврат;
	ИначеЕсли МожноРаспределить > 0 Тогда
		Если Индекс >= ЭффективныеЧасы.Количество() Тогда
			Возврат;
		КонецЕсли;
		ЦБР_РаспределитьЧасы(ЭффективныеЧасы, СтрокаРеализация, Индекс, СтруктураПараметры, МожноРаспределить);
	ИначеЕсли СтруктураПараметры.ОсталосьРаспределить > 0 Тогда
		НоваяСтрока = ЭффективныеЧасы.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрока, ЭффективныеЧасы[Индекс-1], "ПериодЗП, Исполнитель");
		НоваяСтрока.ЭффективныеЧасы = СтруктураПараметры.ОсталосьРаспределить; 
	ИначеЕсли ОсталисьЭффективныеЧасы > 0 Тогда
		НоваяСтрока = ЭффективныеЧасы.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрока, ЭффективныеЧасы[Индекс-1], "ПериодЗП, Исполнитель");
		НоваяСтрока.ЭффективныеЧасы = ОсталисьЭффективныеЧасы; 
	КонецЕсли;  
	
КонецПроцедуры

&НаСервереБезКонтекста
Процедура РаспределитьЧасы(ЭффективныеЧасы, СтрокаРеализация, Индекс, ОсталосьРаспределить, МожноРаспределить);
	
	СтрокаРаспределения = ЭффективныеЧасы[Индекс];  
	
	Если СтрокаРаспределения.ВидЧаса <> СтрокаРеализация.ВидЧаса Тогда
		Возврат;
	КонецЕсли;	
	
	Если ЗначениеЗаполнено(СтрокаРаспределения.Реализация) Тогда
		Индекс = Индекс+1;
		РаспределитьЧасы(ЭффективныеЧасы, СтрокаРеализация, Индекс, ОсталосьРаспределить, МожноРаспределить);
		Возврат;
	КонецЕсли;
	
	ОсталосьРаспределить = СтрокаРаспределения.ЭффективныеЧасы;
	СтрокаРаспределения.ЭффективныеЧасы = ?(?(МожноРаспределить>0, МожноРаспределить, СтрокаРеализация.ЧасыОстаток) >= ОсталосьРаспределить, ОсталосьРаспределить, ?(МожноРаспределить>0, МожноРаспределить, СтрокаРеализация.ЧасыОстаток));
	ОсталосьРаспределить = ОсталосьРаспределить - СтрокаРаспределения.ЭффективныеЧасы;
	МожноРаспределить = ?(МожноРаспределить>0,МожноРаспределить,СтрокаРеализация.ЧасыОстаток) - СтрокаРаспределения.ЭффективныеЧасы;

	СтрокаРаспределения.Реализация = СтрокаРеализация.Реализация;
	СтрокаРаспределения.ВидЧаса    = СтрокаРеализация.ВидЧаса;

	Индекс = Индекс+1;  
		
	Если ОсталосьРаспределить > 0 И МожноРаспределить > 0 Тогда
		НоваяСтрока = ЭффективныеЧасы.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрока, ЭффективныеЧасы[Индекс-1]);
		НоваяСтрока.ЭффективныеЧасы = ОсталосьРаспределить;
		ЭффективныеЧасы.Сдвинуть(НоваяСтрока, -1);
		Возврат;
	ИначеЕсли МожноРаспределить > 0 Тогда
		Если Индекс >= ЭффективныеЧасы.Количество() Тогда
			Возврат;
		КонецЕсли;
		РаспределитьЧасы(ЭффективныеЧасы, СтрокаРеализация, Индекс, ОсталосьРаспределить, МожноРаспределить);
	ИначеЕсли ОсталосьРаспределить > 0 Тогда
		НоваяСтрока = ЭффективныеЧасы.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрока, ЭффективныеЧасы[Индекс-1], "Дата, Комментарий, Исполнитель");
		НоваяСтрока.ЭффективныеЧасы = ОсталосьРаспределить;
	КонецЕсли;  
	
КонецПроцедуры

&НаСервере
Процедура ОбновитьТаблицуРеализаций(Партнер = Неопределено)
	
	ТаблицаРеализаций.Очистить();
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ЦБР_ЧасыКлиентовОстаткиИОбороты.Акт КАК Реализация,
	|	ЦБР_ЧасыКлиентовОстаткиИОбороты.ВидЧаса КАК ВидЧаса,
	|	ЦБР_ЧасыКлиентовОстаткиИОбороты.ЧасыОстаток КАК ЧасыОстаток,
	|	ЛОЖЬ КАК Выбрана,
	|	ЦБР_ЧасыКлиентовОстаткиИОбороты.Акт.Дата КАК АктДата
	|ИЗ
	|	РегистрНакопления.ЦБР_ЧасыКлиентов.Остатки(, Контрагент.Партнер = &Партнер) КАК ЦБР_ЧасыКлиентовОстаткиИОбороты
	|ГДЕ
	|	ЦБР_ЧасыКлиентовОстаткиИОбороты.ЧасыОстаток > 0
	|
	|УПОРЯДОЧИТЬ ПО
	|	АктДата"
	;
	Запрос.УстановитьПараметр("Партнер", Партнер);  
	
	ТаблицаРеализаций.Загрузить(Запрос.Выполнить().Выгрузить());
	
КонецПроцедуры

&НаКлиенте
Процедура РазбитьНаДвеСтроки(Команда)
	
	ТекущаяСтрока = Элементы.ДеревоЗадач.ТекущиеДанные;
	
	Если ТекущаяСтрока.Задание <> ПредопределенноеЗначение("Документ.ЦБР_Задание.ПустаяСсылка") Тогда 
		
		СтруктураТекущихДанных = Новый Структура();
		СтруктураТекущихДанных.Вставить("БесплатныеЧасы", ТекущаяСтрока.Бесплатные);
		СтруктураТекущихДанных.Вставить("ПлатныеЧасы", ТекущаяСтрока.Эффективные);
		СтруктураТекущихДанных.Вставить("ИТСЧасы", ТекущаяСтрока.ИТС);
		СтруктураТекущихДанных.Вставить("ЧасыУстановки", ТекущаяСтрока.Установочные);
		
		ОписаниеОповещенияПослеЗаполнения = Новый ОписаниеОповещения("РазделитьЧасыВРеализацииЗавершение", ЭтотОбъект);
		ОткрытьФорму("Обработка.ЦБР_АРМПрикрепленияРеализаций.Форма.ФормаРазделенияЧасов", СтруктураТекущихДанных, ЭтаФорма,,,, ОписаниеОповещенияПослеЗаполнения, РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
		
	КонецЕсли;  
	
КонецПроцедуры

&НаКлиенте
Процедура УстановитьЗаСчетКомпании(Команда)
	
	ТекущаяСтрока = Элементы.ДеревоЗадач.ТекущиеДанные;
	
	Если ТекущаяСтрока.Задание <> ПредопределенноеЗначение("Документ.ЦБР_Задание.ПустаяСсылка") Тогда
		УстановитьЗаСчетКомпанииНаСервере(ТекущаяСтрока.Задание, ТекущаяСтрока.Эффективные, ТекущаяСтрока.ПериодЗП); 
	КонецЕсли;  
	
	ОбновитьДеревоЗадач();
	ОбновитьТаблицуРеализаций();
	
КонецПроцедуры

&НаСервере
Процедура УстановитьЗаСчетКомпанииНаСервере(Задание, Эффективные, ПериодЗП)
	
	ОбъектЗадания = Задание.ПолучитьОбъект();	
	
	ОсталосьРаспределить = Эффективные;
	
	Для Каждого Стр Из ОбъектЗадания.ЧасыЗП Цикл
		
		Если ОсталосьРаспределить <= 0 Тогда
			Прервать;
		КонецЕсли;
		
		Если ЗначениеЗаполнено(Стр.Реализация) Тогда
			Продолжить;
		КонецЕсли;
		
		Если Стр.ПериодЗП <> ПериодЗП Тогда
			Прервать;
		КонецЕсли;
		
		Если Стр.ВидЧаса = Перечисления.ЦБР_ВидыЧасовПоЗадачам.Платные Тогда
			Если Стр.ЭффективныеЧасы > ОсталосьРаспределить Тогда
				НоваяСтр = ОбъектЗадания.ЧасыЗП.Добавить();
				ЗаполнитьЗначенияСвойств(НоваяСтр,Стр);
				НоваяСтр.ЭффективныеЧасы = ОсталосьРаспределить;
				НоваяСтр.ЗаСчетКомпании  = Истина;
				Стр.ЭффективныеЧасы      = Стр.ЭффективныеЧасы - ОсталосьРаспределить;
				ОсталосьРаспределить     = 0;
            ИначеЕсли Стр.ЭффективныеЧасы <= ОсталосьРаспределить Тогда
				Стр.ЗаСчетКомпании       = Истина;
				ОсталосьРаспределить     = ОсталосьРаспределить - Стр.ЭффективныеЧасы;
			КонецЕсли;	
		КонецЕсли;	
	КонецЦикла;	
	
	ОбъектЗадания.Записать(РежимЗаписиДокумента.Проведение);
	
КонецПроцедуры

&НаКлиенте
Процедура РазделитьЧасыВРеализацииЗавершение(Результат, ДопПараметры) Экспорт
		
	Если Результат <> Неопределено Тогда  
		НужнаНоваяСтрока = Ложь;
		ТекущаяСтрока = Элементы.ДеревоЗадач.ТекущиеДанные;
		Если Результат.БесплатныеЧасы <> 0 Тогда
			ТекущаяСтрока.Бесплатные = ТекущаяСтрока.Бесплатные - Результат.БесплатныеЧасы;
			НужнаНоваяСтрока = Истина; 
		КонецЕсли;
		Если Результат.ПлатныеЧасы <> 0 Тогда
			ТекущаяСтрока.Эффективные = ТекущаяСтрока.Эффективные - Результат.ПлатныеЧасы;
			НужнаНоваяСтрока = Истина; 
		КонецЕсли;
		Если Результат.ИТСЧасы <> 0 Тогда
			ТекущаяСтрока.ИТС = ТекущаяСтрока.ИТС - Результат.ИТСЧасы;
			НужнаНоваяСтрока = Истина; 
		КонецЕсли;
		Если Результат.ЧасыУстановки <> 0 Тогда
			ТекущаяСтрока.Установочные = ТекущаяСтрока.Установочные - Результат.ЧасыУстановки;
			НужнаНоваяСтрока = Истина; 
		КонецЕсли;  
		Если НужнаНоваяСтрока Тогда
			ИдентификаторСтроки = Элементы.ДеревоЗадач.ТекущаяСтрока;
			ТекущаяСтрока       = ДеревоЗадач.НайтиПоИдентификатору(ИдентификаторСтроки);
			СтрокаРодитель      = ТекущаяСтрока.ПолучитьРодителя();
			НоваяСтрокаДерева   = СтрокаРодитель.ПолучитьЭлементы().Добавить();
			ЗаполнитьЗначенияСвойств(НоваяСтрокаДерева, ТекущаяСтрока);  
			НоваяСтрокаДерева.Бесплатные   = Результат.БесплатныеЧасы;
			НоваяСтрокаДерева.Эффективные  = Результат.ПлатныеЧасы;
			НоваяСтрокаДерева.ИТС          = Результат.ИТСЧасы;
			НоваяСтрокаДерева.Установочные = Результат.ЧасыУстановки;
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти
  

